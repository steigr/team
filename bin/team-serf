#!/bin/sh

set -x

. $TEAM_LIB/serf.lib
. $TEAM_LIB/network.lib
. $TEAM_LIB/rancher.lib
. $TEAM_LIB/team.lib
. $TEAM_LIB/coreos.lib

case "$1" in
  nodes)
    $(serf_bin) members -status=alive $* 2>/dev/null
  ;;
  command)
    echo "$(serf_bin) agent -config-file=$(serf_config_file)"    
  ;;
  start)
    $TEAM serf config
    $TEAM serf unit
    $TEAM coreos start serf.service
  ;;
  install|update)
    serf_install
  ;;
  config)
    echo "Writing Serf Configuration $(serf_config_file)"
    cat<<EO_CONFIG | tee $(serf_config_file)
{
  "discover":"$(ranch)",
  "tags":{
    "coreos":"true"
  },
  "node_name":"$(hostname -s)",
  "snapshot_path":"$(serf_snapshot)",
  "rejoin_after_leave":true,
  "disable_name_resolution":true,
  "event_handlers":[
    "$TEAM"
  ]
}
EO_CONFIG
  ;;
  unit)
    echo "Writing Serf Unit File $(coreos_unit service serf)"
    cat<<EO_UNIT | tee $(coreos_unit service serf)
[Unit]
Description=Serf Cluster Discovery and Event Processing
[Service]
ExecStartPre=$TEAM serf config
ExecStart=$($TEAM serf command)
EO_UNIT
    coreos_init reload
  ;;
esac