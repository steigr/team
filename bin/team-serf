#!/bin/sh

. $TEAM_LIB/serf.lib
. $TEAM_LIB/network.lib
. $TEAM_LIB/rancher.lib
. $TEAM_LIB/team.lib
. $TEAM_LIB/coreos.lib

arg=$1
shift

case "$arg" in
  event)
    $(serf_bin) event $*
  ;;
  nodes)
    $(serf_bin) members -status=alive $* 2>/dev/null
  ;;
  count-nodes)
    test -z "$($(serf_bin) members -status=alive $* 2>/dev/null)" \
    && echo 0 \
    || $(serf_bin) members -status=alive $* 2>/dev/null | wc -l
  ;;
  command)
    echo "$(serf_bin) agent -config-file=$(serf_config_file)"    
  ;;
  install|update)
    serf_install
  ;;
  unit)
    echo "Writing Serf Unit File $(coreos_unit service serf)"
    serf_write_unit $(coreos_unit service serf)
  ;;
  config)
    echo "Writing Serf Configuration $(serf_config_file)"
    serf_write_config $(serf_config_file)
  ;;
  start)
    $TEAM serf unit
    $TEAM coreos start serf.service
  ;;
  restart)
    $TEAM coreos stop serf.service
    $TEAM serf start
  ;;
  set)
    for tag in $*; do
      $(serf_bin) tags -set $tag
    done
  ;;
  query)
    $(serf_bin) query -timeout=${TIMEOUT:-1s} $* | grep "^Response: " 
  ;;
  check)
    [[ "x" = "x$($TEAM swarm local-token)" ]] || $TEAM serf set swarm-token=true
  ;;
esac