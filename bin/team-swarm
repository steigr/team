#!/bin/sh

set -x

. $TEAM_LIB/team.lib
. $TEAM_LIB/network.lib
. $TEAM_LIB/swarm.lib
. $TEAM_LIB/docker.lib
. $TEAM_LIB/coreos.lib

arg=$1
shift

case "$arg" in
  frontend-unit)
    swarm_write_frontend_unit $(coreos_unit swarm)
  ;;
  annoucement-unit)
    swarm_write_announcement_unit $(coreos_unit bee)
  ;;
  token)
    echo "Pulling Discovery Token"
    token=$(swarm_token_read)
    token=${token:-$(swarm_token_receive)}
    # token=$(swarm_receive_token)
    # [[ -z "$token" ]] && token=$(swarm_create_token)
    # if [[ 0 -eq $($TEAM serf count-nodes -tag swarm-token=true) ]]
    # $TEAM serf query -tags swarm-token=true swarm-token
  ;;
  create-token)
    $TEAM docker bind tcp
    token=$($(coreos_early_docker) /usr/bin/docker run --net=host swarm create)
    swarm_token_write $token
  ;;
  environment)
    dest=$1
    echo "SWARM_ADDR=tcp://$(private_ipv4_address):$(docker_tcp_port)"
    echo "SWARM_DISCOVERY=token://$($TEAM swarm token)"
  ;;
esac