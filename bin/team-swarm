#!/bin/sh

set -x

. $TEAM_LIB/team.lib
. $TEAM_LIB/network.lib
. $TEAM_LIB/swarm.lib
. $TEAM_LIB/docker.lib
. $TEAM_LIB/coreos.lib

arg=$1
shift

case "$arg" in
  frontend-unit)
    swarm_write_frontend_unit $(coreos_unit swarm)
  ;;
  annoucement-unit)
    swarm_write_announcement_unit $(coreos_unit bee)
  ;;
  token)
    token=$(swarm_token_read)
    token=${token:-$(swarm_token_receive)}
    test "x" = "x$token" && $TEAM swarm create-token
    echo $token
  ;;
  create-token)
    token=$(coreos_early_docker run --net=host swarm create)
    swarm_token_write token://$token
  ;;
  environment)
    dest=$1
    mkdir -p /run/swarm 2>/dev/null
    touch /run/swarm/env
    echo "SWARM_ADDR=tcp://$(private_ipv4_address):$(docker_tcp_port)" >> /run/swarm/env
    echo "SWARM_DISCOVERY=$($TEAM swarm token)" >> /run/swarm/env
  ;;
esac