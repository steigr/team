#!/bin/sh

set -x

. $TEAM_LIB/team.lib
. $TEAM_LIB/network.lib
. $TEAM_LIB/swarm.lib
. $TEAM_LIB/coreos.lib

case "$1" in
  frontend-unit)
    swarm_write_frontend_unit $(coreos_unit swarm)
  ;;
  annoucement-unit)
    swarm_write_announcement_unit $(coreos_unit bee)
  ;;
  token)
    echo "Pulling Discovery Token"
    token=$(swarm_receive_token)
    [[ -z "$token" ]] && token=$(swarm_create_token)
    if [[ 0 -eq $($TEAM serf count-nodes -tag swarm-token=true) ]]
    $TEAM serf query -tags swarm-token=true swarm-token
  ;;
  create-token)
    $TEAM docker bind tcp
    token=$(docker run --net=host swarm create)
  ;;
esac