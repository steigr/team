#!/bin/sh

set -x

. $TEAM_LIB/team.lib
. $TEAM_LIB/network.lib
. $TEAM_LIB/swarm.lib
. $TEAM_LIB/docker.lib
. $TEAM_LIB/coreos.lib

arg=$1
shift

case "$arg" in
  frontend-unit)
    swarm_write_frontend_unit $(coreos_unit swarm)
  ;;
  annoucement-unit)
    swarm_write_announcement_unit $(coreos_unit bee)
  ;;
  token)
    echo "Pulling Discovery Token"
    token=$(swarm_token_read)
    token=${token:-$(swarm_token_receive)}
    echo $token
  ;;
  create-token)
    $TEAM docker bind tcp
    token=$(coreos_early_docker run --net=host swarm create)
    swarm_token_write $token
  ;;
  environment)
    dest=$1
    echo "SWARM_ADDR=tcp://$(private_ipv4_address):$(docker_tcp_port)"
    echo "SWARM_DISCOVERY=token://$($TEAM swarm token)"
  ;;
esac