. $TEAM_LIB/team.lib
. $TEAM_LIB/serf.lib
. $TEAM_LIB/network.lib
. $TEAM_LIB/coreos.lib

registry_install() {
  registry_stop
  _registry_write_unit $(coreos_unit registry)
  registry_start
}

registry_start() {
  coreos_start registry 
}

registry_stop() {
  coreos_stop registry 
}

registry_ip() {
  cat $(_registry_ip_file)
}

registry_cluster-ip() {
  TIMEOUT=2s _serf_query registry-ip | grep $(_registry_ip_var) | head -n1 | awk -F$(_registry_ip_var) '{print $2}' | awk '{print $1}'
}

registry_write-ip() {
  out=${1:-$(_registry_ip_file)}
  mkdir -p $(dirname $out)
  id=$(docker ps | awk '{print $1 "  " $2}' | grep " registry:2" | awk '{print $1}')
  echo -n $(_registry_ip_var) > $out
  docker inspect --format '{{ .NetworkSettings.IPAddress }}' $id >> $out
}

_registry_container_name() {
  echo "registry"
}

_registry_write_unit() {
  cat<<EO_REGISTRY_UNIT
[Unit]
Description=Docker Distribution Registry
[Service]
ExecStartPre=-/usr/bin/docker rm $(_registry_container_name)
ExecStart=/usr/bin/docker run -d -P -e INTERLOCK_DATA='{"ssl_only":true}' -v $(_registry_store):$(_registry_store) --hostname=$(_registry_container_name).$(domainname) registry:2
ExecStartPost=$TEAM registry write-ip $(_registry_ip_file)
ExecStop=-/usr/bin/docker stop $(_registry_container_name)
EO_REGISTRY_UNIT
}

_registry_ip_file() {
  echo "/run/registry/ip"
}

_registry_ip_var() {
  echo "REGISTRY_IP="
}

_registry_store() {
  echo "/var/lib/registry"
}