. $TEAM_LIB/team.lib
. $TEAM_LIB/serf.lib
. $TEAM_LIB/network.lib
. $TEAM_LIB/coreos.lib

_registry_test() {
  true
  # [[ -z "$(TIMEOUT=6s _serf_query registry-ip | grep ^REGISTRY_IP= )" ]] || exit 1
}

registry_install() {
  registry_stop
  _registry_write_unit $(coreos_unit registry)
  registry_start
}

registry_start() {
  coreos_start registry 
}

registry_stop() {
  coreos_stop registry 
}

registry_ip() {
  echo REGISTRY_IP="$(docker inspect --format '{{ .NetworkSettings.IPAddress }}' $(_registry_container_name))"
}

_registry_container_name() {
  echo "registry"
}

_registry_write_unit() {
  cat<<EO_REGISTRY_UNIT
[Unit]
Description=Docker Distribution Registry
[Service]
ExecStartPre=-/usr/bin/docker rm $(_registry_container_name)
ExecStart=/usr/bin/docker run -d -P --name=$(_registry_container_name) --hostname=$(_registry_container_name).$(domainname) registry:2
ExecStop=-/usr/bin/docker stop $(_registry_container_name)
EO_REGISTRY_UNIT
}

