. $TEAM_LIB/team.lib
. $TEAM_LIB/serf.lib
. $TEAM_LIB/network.lib
. $TEAM_LIB/coreos.lib

registry_install() {
  registry_stop
  _registry_write_unit $(coreos_unit registry)
  registry_start
}

registry_start() {
  coreos_start registry 
}

registry_stop() {
  coreos_stop registry 
}

registry_ip() {
  cat $(_registry_ip_file)
}

registry_cluster-ip() {
  TIMEOUT=2s _serf_query registry-ip | grep $(_registry_ip_var) | head -n1 | awk -F$(_registry_ip_var) '{print $2}' | awk '{print $1}'
}

registry_env() {
  mkdir -p $(dirname $(_registry_env_file)) >/dev/null
  cat<<EO_REGISTRY_ENVIRONMENT | tee $(_registry_env_file) >/dev/null
REGISTRY_STORAGE_FILESYSTEM_ROOTDIRECTORY=$(_registry_store)
INTERLOCK_DATA='{"ssl_only":true}'
EO_REGISTRY_ENVIRONMENT
}

registry_write-ip() {
  out=${1:-$(_registry_ip_file)}
  mkdir -p $(dirname $out)
  echo -n $(_registry_ip_var) > $out
  docker inspect --format '{{ .NetworkSettings.IPAddress }}' $(_registry_id) >> $out
}

registry_halt() {
  while : ; do
    id=$(_registry_id)
    [[ -z "$id" ]] && exit 0
    /usr/bin/docker stop $id
  done
}

registry_remove() {
  while : ; do
    id=$(_registry_id -a)
    [[ -z "$id" ]] && exit 0
    /usr/bin/docker rm $id
  done
}

_registry_container_name() {
  echo "registry"
}

_registry_write_unit() {
  cat<<EO_REGISTRY_UNIT | tee $1 >/dev/null
[Unit]
Description=Docker Distribution Registry
[Service]
ExecStartPre=-$TEAM registry remove
ExecStartPre=$TEAM registry env
ExecStart=/usr/bin/docker run -d -P --env-file=$(_registry_env_file) -v $(_registry_store):$(_registry_store) --hostname=$(_registry_container_name).$(domainname) registry:2
ExecStartPost=$TEAM registry write-ip $(_registry_ip_file)
ExecStop=-$TEAM registry halt
EO_REGISTRY_UNIT
  coreos_init reload
}



_registry_ip_file() {
  echo "/run/registry/ip"
}

_registry_ip_var() {
  echo "REGISTRY_IP="
}

_registry_store() {
  echo "/var/lib/registry"
}

_registry_env_file() {
  echo "/run/registry/env"
}

_registry_id() {
  docker ps ${1} | awk '{print $1 "  " $2}' | grep " registry:2" | head -1 | awk '{print $1}'
}