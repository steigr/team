
. $TEAM_LIB/platform.lib

_default_serf_bin() {
  echo $PREFIX/bin/serf
}

serf_version() {
  echo "0.6.4"
}

serf_node_name() {
  _serf_node_name
}

serf_install() {
  _serf_bin=$(_default_serf_bin)
  _serf_dir=$(dirname $_serf_bin)
  _serf_zip=/tmp/$$.zip
  $(which curl) -SLfslko $_serf_zip  https://dl.bintray.com/mitchellh/serf/$(serf_version)_$(platform)_amd64.zip
  unzip -o $_serf_zip -d $_serf_dir >/dev/null
  rm $_serf_zip
}

serf_bin() {
  test -f $(which serf 2>/dev/null) && test -x $(which serf 2>/dev/null) && _serf_bin=$(which serf 2>/dev/null)
  test -x $(_default_serf_bin) && _serf_bin=$(_default_serf_bin)
  test "x" = "x$_serf_bin" && serf_install
  echo $_serf_bin
}

serf_config_file() {
  mkdir -p "$PREFIX/tmp"
  echo "$PREFIX/tmp/serf.json"
}

serf_snapshot() {
  local _snapshot="$PREFIX/var/lib/serf"
  mkdir -p "$_snapshot"
  echo "$_snapshot/snapshot"
}
serf_write_config() {
    cat<<EO_CONFIG | tee $1
{
  "discover":"$(ranch)",
  "tags":{
    "coreos":"true"
  },
  "node_name":"$(serf_node_name)",
  "snapshot_path":"$(serf_snapshot)",
  "rejoin_after_leave":true,
  "disable_name_resolution":true,
  "event_handlers":[
    "$TEAM"
  ],
  "log_level":"debug"
}
EO_CONFIG
}

serf_write_unit() {
  cat<<EO_UNIT | tee $1
[Unit]
Description=Serf Cluster Discovery and Event Processing
[Service]
Restart=always
ExecStartPre=$TEAM serf config
ExecStart=$($TEAM serf command)
EO_UNIT
  coreos_init reload
}

serf_check() {
  result=$(/bin/sh -c "$TEAM $1" )
  [[ "x" = "x$result" ]] && $TEAM serf unset $2 || $TEAM serf set $2=true
}

_serf_query() {
  $(serf_bin) query -timeout=${TIMEOUT:-1s} $*
}

_serf_query_filter() {
  cat | awk -F$1 '{print $2}' | awk '{print $1}' | grep -v "^$"
}

_serf_node_name() {
  (hostname -a 2>/dev/null || hostname -f 2>/dev/null) | cut -f1 -d"."
}