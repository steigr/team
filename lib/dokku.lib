require team
require coreos
require serf
require docker

set -x

dokku_update() {
  dokku_stop
  dokku_install
}

dokku_install() {
  _dokku_build_container
  dokku_start
}

dokku_start() {
  _coreos_start dokku
}

dokku_stop() {
  _coreos_stop dokku
}

dokku_env() {
  _dokku_env
}

dokku_nerve() {
  _dokku_nerve
}

dokku_nerve-config() {
  _dokku_nerve_json
}

dokku_ip() {
  _serf_query dokku-ip | _serf_query_filter $(_dokku_ip_var) | head -n1
}

dokku_local-ip() {
  _docker_ip $(_dokku_container_name)
}

dokku_id() {
  _docker_ids_by_image "dokku" | head -1
}

dokku_rm() {
  for id in $(_docker_ids_by_image $(_dokku_image_name)); do
    docker rm $id
  done
}

_dokku_container_name() {
  _docker_name_by_id $(dokku_id)
}

_dokku_image_name() {
  echo "dokku"
}

_dokku_stop_container() {
  coreos_stop $(_dokku_container_name)
}

_dokku_start_container() {
  _dokku_unit_write $(coreos_unit dokku)
  _coreos_start $(_dokku_container_name)
}

_dokku_authorized_keys() {
  echo "/home/core/.ssh/authorized_keys"
}

_dokku_graph_dir() {
  echo "/var/lib/docker"
}

_dokku_docker_socket() {
  echo "/var/run/docker.sock"
}

_dokku_base_container() {
  _dokku_container_name
}

_dokku_build_container() {
  set -x
  temp_dir=$(mktemp -d)
  _dokku_write_dockerfile $temp_dir
  _dokku_entrypoint_write $temp_dir
  docker build -t $(_dokku_image_name) $temp_dir
  rm -r $temp_dir
  cmd=$(_dokku_docker_command "--entrypoint=/bin/sh -t -d")
  id=$cmd
  set -e
  _dokku_bootstrap_commands | while read cmd; do
    docker exec -t $id /bin/bash -l -c "$cmd"
  done
  set +e
  docker stop $id
  docker commit $id
  docker tag -f $i $(_dokku_image_name)
  docker rm $id  
}

_dokku_docker_command() {
  echo "/usr/bin/docker run --privileged -v $(_dokku_nerve_config):$(_dokku_nerve_config) -v $(_dokku_nerve_config):$(_dokku_nerve_config) -v $(_dokku_home):$(_dokku_home) -v $(_dokku_authorized_keys):$(_dokku_authorized_keys) -v $(_dokku_graph_dir):$(_dokku_graph_dir) -v $(_dokku_docker_socket):$(_dokku_docker_socket) $1 $(_dokku_image_name)"
}

_dokku_unit_write() {
  _coreos_write_unit $(coreos_unit dokku) <<EO_DOKKU_UNIT
[Unit]
Description=Dokku PaaS
Requires=early-docker.service
After=early-docker.service
[Service]
Restart=always
ExecStartPre=-$TEAM dokku rm
ExecStartPre=$TEAM dokku env
ExecStart=$(_dokku_docker_command)
EO_DOKKU_UNIT
}

_dokku_nerve() {
  _coreos_stop dokku-nerve
  _coreos_write_unit $(coreos_unit dokku-nerve) <<EO_DOKKU_NERVE_UNIT
[Unit]
Description=Dokku Paas Service Annoucement
Requires=dokku.service
After=dokku.service
[Service]
Restart=always
ExecStartPre=$TEAM dokku nerve-config
ExecStart=$TEAM dokku exec /start nerve
EO_DOKKU_NERVE_UNIT
  _coreos_start dokku-nerve
}

_dokku_write_dockerfile() {
  cat <<EO_DOKKU_DOCKERFILE | tee $1/Dockerfile >/dev/null
FROM ubuntu:latest
MAINTAINER Mathias Kaufmann <me@stei.gr>
RUN ping -c1 de.archive.ubuntu.com \
 && sed -i -e "s@http://archive@http://de.archive@g" /etc/apt/sources.list
RUN export DEBIAN_FRONTEND=noninteractive \
 && apt-get update \
 && apt-get dist-upgrade -y \
 && apt-get autoremove -y
RUN export DEBIAN_FRONTEND=noninteractive \
 && apt-get install curl openssh-server openssh-client apt-transport-https ca-certificates ruby ruby-dev make gcc -y
RUN gem install nerve synapse foreman --no-ri --no-rdoc
RUN curl -fLo bootstrap.sh https://raw.github.com/progrium/dokku/v0.3.18/bootstrap.sh \
 && sed -i -e 's:"linux-image-extra-\$(uname -r)"::' bootstrap.sh \
 && test -f /sbin/modprobe.real || mv /sbin/modprobe /sbin/modprobe.real \
 && test -f /sbin/modprobe      || ln /bin/true /sbin/modprobe
RUN echo dokku dokku/vhost_enable boolean false | debconf-set-selections \
 && echo dokku dokku/web_config boolean false | debconf-set-selections \
 && echo dokku dokku/hostname string dokku.me | debconf-set-selections \
 && echo dokku dokku/key_file string /root/dokku_id.pub | debconf-set-selections \
 && echo dokku dokku/vhost_enable seen true | debconf-set-selections \
 && echo dokku dokku/web_config seen true | debconf-set-selections \
 && echo dokku dokku/hostname seen true | debconf-set-selections \
 && echo dokku dokku/key_file seen true | debconf-set-selections
RUN mkdir /app \
 && echo "ssh: /usr/sbin/sshd -D -f /etc/ssh/sshd_config" > /app/Procfile \
 && echo "nerve: /usr/bin/nerve -c /etc/nerve.json >> /app/Procfile" \
 && echo "synapse: /usr/bin/synapse -c /etc/synapse.json >> /app/Procfile" \
 && cp /app/Procfile /app/.release
ADD $1/(_dokku_entrypoint_file) /$(_dokku_entrypoint_file)
VOLUMES "["$(_dokku_graph_dir)","$(_dokku_docker_socket)","$(_dokku_nerve_config)","$(_dokku_synapse_config)","$(_dokku_home)","$(_dokku_authorized_keys)"]"
ENTRYPOINT ["/start"]
EXPOSE 22
EO_DOKKU_DOCKERFILE

}

_dokku_entrypoint_file() {
  echo "start"
}

_dokku_entrypoint_write() {
  cat <<'EO_DOKKU_ENTRYPOINT' | tee $1/$(_dokku_entrypoint_file) >/dev/null
#!/bin/bash
export HOME=/app
cd /app

case "$(basename $0)" in
  start)
    [[ ! -f Procfile ]] && ruby -e "require 'yaml';File.write('Procfile', (YAML.load_file('.release')['default_process_types'] || {}).to_yaml)"
    command="foreman start --procfile=Procfile $@"
    ;;
  *)
    command="$@"
    ;;
esac

if [[ -z "$command" ]]; then
  echo "Missing command ($@)"
  exit 1
fi

exec $(eval echo ${command})
EO_DOKKU_ENTRYPOINT
}

_dokku_bootstrap_commands() {
  cat<<EO_DOKKU_BOOTSTRAP_COMMANDS
/bin/bash -x bootstrap.sh
groupmod -g $(stat -c %g /run/docker.sock) docker
mkdir -p /root/.ssh
cat $(_dokku_authorized_keys) > /root/.ssh/authorized_keys
tail -1 /root/.ssh/authorized_keys > /root/dokku_id.pub
EO_DOKKU_BOOTSTRAP_COMMANDS
}

_dokku_home() {
  echo "/home/dokku"
}

_dokku_apps() {
  find $(_dokku_home) -mindepth 1 -maxdepth 1 -type d -not -name '.*' | cut -f4 -d/
}

_dokku_env() {
  env_file=$(_dokku_env_file)
  mkdir -p $(dirname $env_file)
  cat <<EO_DOKKU_ENV | tee $env_file >/dev/null
ZK_SERVER=$($TEAM zookeeper ip)
NERVE_PATH="$(_dokku_nerve_ssh_path)"
EO_DOKKU_ENV
}

_dokku_env_file() {
  echo "/run/dokku/env"
}

_dokku_nerve_ssh_path() {
  echo "/team/dokku/ssh/services"
}

_dokku_nerve_json() {
  echo "{'instance_id':'$(serf_node_name)','services':{'ssh':{'host': '$(dokku_local-ip)','port':22,'reporter_type':'zookeeper','zk_hosts': ['$($TEAM zookeeper ip):2181'],'zk_path': '$(_dokku_nerve_ssh_path)','check_interval': 2,'checks': [{'type': 'tcp','timeout': 0.2,'rise': 3,'fall': 2}]}}}" \
  | sed -e "s:':\":g" \
  | tee $(_dokku_nerve_config)
}

_dokku_nerve_config() {
  echo "/run/dokku/nerve"
}

_dokku_synapse_config() {
  echo "/run/dokku/synapse"
}

_dokku_ip_var() {
  echo "DOKKU_IP="
}