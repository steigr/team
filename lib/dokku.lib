require team
require coreos
require serf
require docker
require random
require zookeeper

dokku_update() {
  _dokku_image_present || _dokku_build_image
  dokku_stop
  dokku_install
}

dokku_install() {
  _dokku_unit_write
  dokku_start
}

dokku_start() {
  _coreos_start dokku
}

dokku_stop() {
  _coreos_stop dokku
}

dokku_env() {
  _dokku_env
}

dokku_nerve-config() {
  _dokku_nerve_json
}

dokku_router() {
  _dokku_synapse
}

dokku_synapse-config() {
  _dokku_synapse_json
}

dokku_ip() {
  serf_query dokku-ip | _serf_query_filter $(_dokku_ip_var) | head -n1
}

dokku_local-ip() {
  _docker_ip $(_dokku_container_name)
}

dokku_id() {
  _coreos_active docker || exit 0
  _docker_ids_by_image "dokku" | head -1
}

dokku_rm() {
  for id in $(_docker_ids_by_image $(_dokku_image_name)); do
    docker rm $id
  done
}

dokku_exec() {
  docker exec $(dokku_id) $*
}

dokku_mask() {
  _docker_ids_by_image "steigr/synapse"
}

_dokku_image_present() {
  docker images | grep ^dokku >/dev/null 2>/dev/null
}
_dokku_container_name() {
  _docker_name_by_id $(dokku_id) 2>/dev/null
}

_dokku_image_name() {
  echo "dokku"
}

_dokku_stop_container() {
  coreos_stop $(_dokku_container_name)
}

_dokku_start_container() {
  _dokku_unit_write $(coreos_unit dokku)
  _coreos_start $(_dokku_container_name)
}

_dokku_authorized_keys() {
  echo "/home/core/.ssh/authorized_keys"
}

_dokku_graph_dir() {
  echo "/var/lib/docker"
}

_dokku_docker_socket() {
  echo "/var/run/docker.sock"
}

_dokku_base_container() {
  _dokku_container_name
}

_dokku_docker_command() {
  echo "$(_docker) run -v $(_dokku_authorized_keys):$(_dokku_authorized_keys) -v $(_dokku_docker_socket):$(_dokku_docker_socket) $* $(_dokku_image_name)"
}

_dokku_build_image() {
  set -x
  set -e
  temp_dir=$(mktemp -d /tmp/XXXXXX)
  _dokku_entrypoint_write $temp_dir
  _dokku_write_dockerfile $temp_dir
  docker build -t $(_dokku_image_name) $temp_dir
  rm -r $temp_dir
  _dokku_bootstrap_commands | while read cmd; do
    name=$(_random 8)
    $(_dokku_docker_command -t --name=$name --entrypoint=/bin/sh -v $(_dokku_home):$(_dokku_home)_host) -c "$cmd"
    iid=$(docker commit $name)
    docker tag -f $iid $(_dokku_image_name)
    docker rm $name
  done
  set +e
}

_dokku_write_dockerfile() {
  cat <<EO_DOKKU_DOCKERFILE | tee $1/Dockerfile >/dev/null
FROM ubuntu:latest
MAINTAINER Mathias Kaufmann <me@stei.gr>
RUN export DEBIAN_FRONTEND=noninteractive \
 && ping -c1 de.archive.ubuntu.com \
 && sed -i -e "s@http://archive@http://de.archive@g" /etc/apt/sources.list \
 && apt-get update \
 && apt-get dist-upgrade -y \
 && apt-get autoremove -y \
 && apt-get install curl openssh-server openssh-client apt-transport-https ca-certificates ruby ruby-dev devscripts haproxy -y \
 && apt-get clean \
 && gem install nerve synapse foreman --no-ri --no-rdoc \
 && curl -fLo bootstrap.sh https://raw.github.com/progrium/dokku/v0.3.18/bootstrap.sh \
 && sed -i -e 's:"linux-image-extra-\$(uname -r)"::' bootstrap.sh \
 && test -f /sbin/modprobe.real || mv /sbin/modprobe /sbin/modprobe.real \
 && test -f /sbin/modprobe      || ln /bin/true /sbin/modprobe \
 && echo dokku dokku/vhost_enable boolean false | debconf-set-selections \
 && echo dokku dokku/web_config boolean false | debconf-set-selections \
 && echo dokku dokku/hostname string dokku.me | debconf-set-selections \
 && echo dokku dokku/key_file string /root/dokku_id.pub | debconf-set-selections \
 && echo debconf debconf/frontend noninteractive | debconf-set-selections \
 && echo debconf debconf/frontend string noninteractive | debconf-set-selections \
 && mkdir /app /root/.ssh \
 && echo "ssh: /usr/sbin/sshd -D -f /etc/ssh/sshd_config" > /app/Procfile \
 && echo "nerve: \$(which nerve) -c $(_dokku_nerve_config)" >> /app/Procfile \
 && cp /app/Procfile /app/.release \
 && echo -e '#!/bin/sh\nip -4 -o route get 8.8.8.8 | awk "{print \$7}"' > /bin/default_ip \
 && chmod +x /bin/default-ip \
 && echo -e '#!/bin/bash\necho {"instance_id":"\$(hostname)","services":{"ssh":{"host": "\$(default-ip)","port":22,"reporter_type":"zookeeper","zk_hosts": ["\${ZK_SERVER}:2181"],"zk_path": "$(_dokku_nerve_ssh_path)","check_interval":2,"checks": [{"type":"tcp","timeout":0.2,"rise":3,"fall":2}]}}}' > /bin/nerve-config \
 && chmod +x /bin/nerve-config \
 && echo -e '#!/bin/bash\nmkdir -p /root/.ssh /var/run/sshd 2>/dev/null\n[[ -f /root/.ssh/authorized_keys ]] || head -1 /home/dokku/.ssh/authorized_keys | awk -F" ssh-" "{ print "ssh-" $2 }" >> /root/.ssh/authorized_keys' > /bin/prepare-sshd
 && chmod +x /bin/prepare-sshd
ADD $(_dokku_entrypoint_file) /$(_dokku_entrypoint_file)
EXPOSE 22
ENTRYPOINT ["/start"]
EO_DOKKU_DOCKERFILE
}

_dokku_bootstrap_commands() {
  cat<<EO_DOKKU_BOOTSTRAP_COMMANDS
tail -1 $(_dokku_authorized_keys) > /root/dokku_id.pub
DOKKU_BRANCH=master bash bootstrap.sh || true
groupmod -g $(stat -c %g /run/docker.sock) docker
rsync -arv $(_dokku_home)/ $(_dokku_home)_host
rm /root/dokku_id.pub /root/.ssh/authorized_keys || true
EO_DOKKU_BOOTSTRAP_COMMANDS
}

_dokku_unit_write() {
  _coreos_write_unit $(coreos_unit dokku) <<EO_DOKKU_UNIT
[Unit]
Description=Dokku PaaS
Requires=docker.service
After=docker.service
[Service]
Restart=always
ExecStartPre=-$(_team) dokku rm
ExecStartPre=$(_team) dokku env
ExecStart=$(_dokku_docker_command -v $(_dokku_home):$(_dokku_home) --rm ) /start
EO_DOKKU_UNIT
}

_dokku_synapse() {
  _dokku_public_address || exit
  _coreos_stop dokku-router
  _coreos_write_unit $(coreos_unit dokku-router) <<EO_DOKKU_NERVE_UNIT
[Unit]
Description=Dokku Paas Socket Proxy
[Service]
Restart=always
ExecStartPre=/usr/bin/docker pull steigr/synapse
ExecStartPre=$(_team) dokku synapse-config
ExecStart=/usr/bin/docker run --rm -l load-balancer=dokku -v $(_dokku_synapse_config):/etc/synapse/synapse.json -p $(_dokku_public_address):22:22 steigr/synapse
ExecStop=-$(_team) dokku mask
EO_DOKKU_NERVE_UNIT
  _coreos_start dokku-router
}

_dokku_entrypoint_file() {
  echo "start"
}

_dokku_entrypoint_write() {
  cat <<'EO_DOKKU_ENTRYPOINT' | tee $1/$(_dokku_entrypoint_file) >/dev/null
#!/bin/bash
export HOME=/app
cd /app

nerve-config
prepare-sshd

case "$(basename $0)" in
  start)
    if test ! -f Procfile; then
      ruby -e "require 'yaml';File.write('Procfile', (YAML.load_file('.release')['default_process_types'] || {}).to_yaml)"
    fi
    command="foreman start --procfile=Procfile $@"
    ;;
  *)
    command="$@"
    ;;
esac

if test -z "$command"; then
  echo "Missing command ($@)"
  exit 1
fi

exec $(eval echo ${command})
EO_DOKKU_ENTRYPOINT
  chmod +x $1/$(_dokku_entrypoint_file)
}

_dokku_home() {
  echo "/home/dokku"
}

_dokku_apps() {
  find $(_dokku_home) -mindepth 1 -maxdepth 1 -type d -not -name '.*' | cut -f4 -d/
}

_dokku_env() {
  env_file=$(_dokku_env_file)
  mkdir -p $(dirname $env_file)
  cat <<EO_DOKKU_ENV | tee $env_file >/dev/null
ZK_SERVER=$(zookeeper_ip)
NERVE_PATH="$(_dokku_nerve_ssh_path)"
EO_DOKKU_ENV
  touch $(_dokku_synapse_config)
}

_dokku_env_file() {
  echo "/run/dokku/env"
}

_dokku_nerve_ssh_path() {
  echo "/team/dokku/ssh/services"
}

_dokku_nerve_json() {
  echo "{'instance_id':'$(serf_node-name)','services':{'ssh':{'host': '$(dokku_ip)','port':22,'reporter_type':'zookeeper','zk_hosts': ['$(zookeeper_ip):2181'],'zk_path': '$(_dokku_nerve_ssh_path)','check_interval': 2,'checks': [{'type': 'tcp','timeout': 0.2,'rise': 3,'fall': 2}]}}}" \
  | sed -e "s:':\":g" \
  | tee $(_dokku_nerve_config)
}

_dokku_nerve_config() {
  echo "/tmp/nerve.json"
}

_dokku_synapse_config() {
  echo "/run/dokku/synapse"
}

_dokku_ip_var() {
  echo "DOKKU_IP="
}

_dokku_public_address() {
  address=$(public_ipv4_address)
  [[ -z "$address" ]] && address=$(private_ipv4_address)
  echo $address
}



dokku_service-path() {
  _dokku_nerve_ssh_path
}

dokku_frontend-port() {
  dokku_backend-port
}

dokku_backend-name() {
  _dokku_container_name
}

dokku_backend-ip() {
  dokku_ip
}

dokku_backend-port() {
  echo 22
}

dokku_running() {
  [[ "$(dokku_id 2>/dev/null)" ]] && true || false
}