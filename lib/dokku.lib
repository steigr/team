. $TEAM_LIB/team.lib
. $TEAM_LIB/coreos.lib

_dokku_test() { true; }

dokku_start() {
  _dokku_start_container
}

dokku_stop() {
  _dokku_stop_container
}

dokku_install() {
  dokku_stop
  _dokku_build_container
  dokku_start
}

dokku_env() {
  _dokku_env
}

_dokku_container_name() {
  echo "dokku"
}

_dokku_stop_container() {
  coreos_stop $(_dokku_container_name)
}

_dokku_start_container() {
  _dokku_unit_write $(coreos_unit dokku)
  coreos_start $(_dokku_container_name)
}

_dokku_authorized_keys() {
  echo "/home/core/.ssh/authorized_keys"
}

_dokku_graph_dir() {
  echo "/var/lib/docker"
}

_dokku_docker_socket() {
  echo "/var/run/docker.sock"
}

_dokku_base_container() {
  _dokku_container_name
}

_dokku_build_container() {
  export $(coreos_early_docker_env)
  cnt=$(_dokku_container_name)
  /usr/bin/docker rm $cnt
  /usr/bin/docker run -d -t --privileged --net=host --name $cnt -v $(_dokku_home):$(_dokku_home) -v $(_dokku_authorized_keys):$(_dokku_authorized_keys) -v $(_dokku_graph_dir):$(_dokku_graph_dir) -v $(_dokku_docker_socket):$(_dokku_docker_socket) ubuntu:latest /bin/sh
  set -e
  _dokku_core_install_command | while read cmd; do
    docker exec -t $cnt /bin/sh -l -c "$cmd"
  done
  set +e
  /usr/bin/docker stop $cnt
  id=$(/usr/bin/docker commit $cnt)
  /usr/bin/docker tag $id dokku
  /usr/bin/docker rm $cnt
}

_dokku_unit_write() {
  cat<<EO_DOKKU_UNIT | tee $1 >/dev/null
[Unit]
Description=Dokku PaaS
Requires=early-docker.service
After=early-docker.service
[Service]
Restart=always
Environment=$(coreos_early_docker_env)
ExecStartPre=-/usr/bin/docker rm $(_dokku_container_name)
ExecStartPre=$TEAM dokku env
ExecStart=/usr/bin/docker run --rm -t --privileged --net=host --env-file=$(_dokku_env_file) --name $(_dokku_container_name) -v $(_dokku_home):$(_dokku_home) -v $(_dokku_authorized_keys):$(_dokku_authorized_keys) -v $(_dokku_graph_dir):$(_dokku_graph_dir) -v $(_dokku_docker_socket):$(_dokku_docker_socket) $(_dokku_base_container) /usr/sbin/sshd -D -f /etc/ssh/sshd_config
ExecStop=-/usr/bin/docker stop $(_dokku_container_name)
EO_DOKKU_UNIT
  coreos_init reload
}

_dokku_core_install_command() {
  cat<<DOKKU_INSTALL_CORE_COMMANDS
ping -c1 de.archive.ubuntu.com
sed -i -e "s@http://archive@http://de.archive@g" /etc/apt/sources.list
apt-get update
apt-get dist-upgrade -y
apt-get autoremove -y
apt-get install curl openssh-server openssh-client apt-transport-https ca-certificates -y
/etc/init.d/ssh start
mkdir -p /root/.ssh
cat $(_dokku_authorized_keys) > /root/.ssh/authorized_keys
curl -fLo bootstrap.sh https://raw.github.com/progrium/dokku/v0.3.18/bootstrap.sh
sed -i -e 's:"linux-image-extra-\$(uname -r)"::' bootstrap.sh
test -f /sbin/modprobe.real || mv /sbin/modprobe /sbin/modprobe.real
test -f /sbin/modprobe      || ln /bin/true /sbin/modprobe
tail -1 /root/.ssh/authorized_keys > /root/dokku_id.pub
echo dokku dokku/vhost_enable boolean false | debconf-set-selections
echo dokku dokku/web_config boolean false | debconf-set-selections
echo dokku dokku/hostname string dokku.me | debconf-set-selections
echo dokku dokku/key_file string /root/dokku_id.pub | debconf-set-selections
/bin/bash -x bootstrap.sh
groupmod -g $(stat -c %g /run/docker.sock) docker
DOKKU_INSTALL_CORE_COMMANDS
}

_dokku_home() {
  echo "/home/dokku"
}

_dokku_apps() {
  find $(_dokku_home) -mindepth 1 -maxdepth 1 -type d -not -name '.*' | cut -f4 -d/
}

_dokku_env() {
  env_file=$(_dokku_env_file)
  mkdir -p $(dirname $env_file)
  cat <<EO_DOKKU_ENV | tee $env_file >/dev/null
ZK_SERVER=$(zookeeper_ip)
NERVE_PATH="/team/dokku/ssh/services"
EO_DOKKU_ENV
}

_dokku_env_file() {
  echo "/run/dokku/env"
}